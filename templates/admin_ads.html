{% extends "base.html" %}
{% block title %}Admin ‚Äî Ad Management | HangarLinks{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
        <div>
            <div class="flex items-center gap-3 mb-1">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg,#7c3aed,#1a56db);">
                    <i class="fas fa-ad text-white"></i>
                </div>
                <h1 class="text-3xl font-extrabold text-white">Ad Management</h1>
            </div>
            <p class="text-slate-400 text-sm">Create, manage, and track sponsored placements across HangarLinks</p>
        </div>
        <div class="flex gap-3">
            <a href="{{ url_for('main.admin_listings') }}"
                class="px-4 py-2 rounded-xl text-sm font-semibold border border-white/20 text-slate-300 hover:bg-white/10 transition-all">
                <i class="fas fa-star mr-1.5"></i>Listings
            </a>
            <button data-modal-target="create-ad-modal" data-modal-toggle="create-ad-modal"
                class="px-5 py-2 rounded-xl text-sm font-bold text-white transition-all hover:-translate-y-0.5 active:scale-95"
                style="background: linear-gradient(135deg,#7c3aed,#1a56db);">
                <i class="fas fa-plus mr-2"></i>Create Ad
            </button>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="mb-6 px-4 py-3 rounded-xl text-sm font-medium
        {% if category == 'success' %}bg-green-500/15 border border-green-500/30 text-green-300
        {% elif category == 'warning' %}bg-amber-500/15 border border-amber-500/30 text-amber-300
        {% else %}bg-red-500/15 border border-red-500/30 text-red-300{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- ‚îÄ‚îÄ Stats ‚îÄ‚îÄ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="rounded-xl p-5 border border-green-500/20 flex items-center gap-4"
            style="background: rgba(16,185,129,0.07);">
            <div class="w-11 h-11 rounded-xl bg-green-500/20 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-check-circle text-green-400 text-lg"></i>
            </div>
            <div>
                <p class="text-xs text-green-400/70 font-bold uppercase tracking-wider mb-0.5">Active Ads</p>
                <p class="text-3xl font-extrabold text-white">{{ active_ads_count }}</p>
            </div>
        </div>
        <div class="rounded-xl p-5 border border-blue-500/20 flex items-center gap-4"
            style="background: rgba(59,130,246,0.07);">
            <div class="w-11 h-11 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-eye text-blue-400 text-lg"></i>
            </div>
            <div>
                <p class="text-xs text-blue-400/70 font-bold uppercase tracking-wider mb-0.5">Total Impressions</p>
                <p class="text-3xl font-extrabold text-white">{{ "{:,}".format(total_impressions) }}</p>
            </div>
        </div>
        <div class="rounded-xl p-5 border border-purple-500/20 flex items-center gap-4"
            style="background: rgba(124,58,237,0.07);">
            <div class="w-11 h-11 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-mouse-pointer text-purple-400 text-lg"></i>
            </div>
            <div>
                <p class="text-xs text-purple-400/70 font-bold uppercase tracking-wider mb-0.5">Total Clicks</p>
                <p class="text-3xl font-extrabold text-white">{{ "{:,}".format(total_clicks) }}</p>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Ads Table ‚îÄ‚îÄ -->
    <div class="rounded-2xl overflow-hidden border border-white/10" style="background: rgba(255,255,255,0.03);">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr style="background: rgba(255,255,255,0.06); border-bottom: 1px solid rgba(255,255,255,0.08);">
                        <th class="px-5 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Ad
                        </th>
                        <th class="px-5 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Placement</th>
                        <th class="px-5 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Status
                        </th>
                        <th class="px-5 py-3 text-right text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Impressions</th>
                        <th class="px-5 py-3 text-right text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Clicks</th>
                        <th class="px-5 py-3 text-right text-xs font-bold text-slate-400 uppercase tracking-wider">CTR
                        </th>
                        <th class="px-5 py-3 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ad in ads %}
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                        <!-- Ad preview + title -->
                        <td class="px-5 py-3.5">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 rounded-lg overflow-hidden bg-white/10 flex-shrink-0 border border-white/10">
                                    <img src="{{ ad.image_url }}" alt="{{ ad.title }}"
                                        class="w-full h-full object-cover"
                                        onerror="this.src='https://placehold.co/48x48/1e293b/64748b?text=Ad'">
                                </div>
                                <div>
                                    <p class="font-bold text-white text-sm">{{ ad.title }}</p>
                                    <a href="{{ ad.link_url }}" target="_blank"
                                        class="text-xs text-blue-400 hover:text-blue-300 truncate max-w-[160px] block">
                                        {{ ad.link_url | truncate(40) }}
                                    </a>
                                </div>
                            </div>
                        </td>

                        <!-- Placement badge -->
                        <td class="px-5 py-3.5">
                            {% set p_colors = {
                            'home_banner': ('bg-blue-500/15 text-blue-400 border-blue-500/25', 'Home Banner'),
                            'search_sidebar': ('bg-purple-500/15 text-purple-400 border-purple-500/25', 'Search
                            Sidebar'),
                            'listing_detail': ('bg-green-500/15 text-green-400 border-green-500/25', 'Listing Detail'),
                            } %}
                            {% set color, label = p_colors.get(ad.placement, ('bg-slate-500/15 text-slate-400
                            border-slate-500/25', ad.placement)) %}
                            <span class="px-2 py-0.5 rounded-full text-xs font-bold border {{ color }}">{{ label
                                }}</span>
                        </td>

                        <!-- Status toggle -->
                        <td class="px-5 py-3.5">
                            {% if ad.active %}
                            <span
                                class="px-2 py-0.5 rounded-full text-xs font-bold bg-green-500/15 text-green-400 border border-green-500/25">
                                ‚óè Active
                            </span>
                            {% else %}
                            <span
                                class="px-2 py-0.5 rounded-full text-xs font-bold bg-slate-500/15 text-slate-400 border border-slate-600/20">
                                ‚óã Paused
                            </span>
                            {% endif %}
                        </td>

                        <!-- Stats -->
                        <td class="px-5 py-3.5 text-right text-slate-300">{{ "{:,}".format(ad.impressions) }}</td>
                        <td class="px-5 py-3.5 text-right text-slate-300">{{ "{:,}".format(ad.clicks) }}</td>
                        <td class="px-5 py-3.5 text-right">
                            {% if ad.impressions > 0 %}
                            <span class="text-amber-400 font-semibold">
                                {{ "%.1f"|format(ad.clicks / ad.impressions * 100) }}%
                            </span>
                            {% else %}
                            <span class="text-slate-600">‚Äî</span>
                            {% endif %}
                        </td>

                        <!-- Action buttons -->
                        <td class="px-5 py-3.5">
                            <div class="flex items-center justify-center gap-2">
                                <!-- Toggle active/paused -->
                                <form action="{{ url_for('main.toggle_ad', ad_id=ad.id) }}" method="POST"
                                    class="inline">
                                    <button type="submit"
                                        class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all hover:scale-105"
                                        style="{% if ad.active %}background:rgba(239,68,68,0.15);color:#f87171;border:1px solid rgba(239,68,68,0.3);{% else %}background:rgba(16,185,129,0.15);color:#34d399;border:1px solid rgba(16,185,129,0.3);{% endif %}">
                                        {{ 'Pause' if ad.active else 'Enable' }}
                                    </button>
                                </form>
                                <!-- Delete -->
                                <form action="{{ url_for('main.delete_ad', ad_id=ad.id) }}" method="POST" class="inline"
                                    onsubmit="return confirm('Permanently delete this ad?')">
                                    <button type="submit"
                                        class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all hover:scale-105"
                                        style="background:rgba(239,68,68,0.1);color:#f87171;border:1px solid rgba(239,68,68,0.2);">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-5 py-16 text-center">
                            <i class="fas fa-photo-video text-4xl text-slate-700 mb-4 block"></i>
                            <p class="text-slate-500 font-medium">No ads yet.</p>
                            <p class="text-slate-600 text-sm mt-1">Click <strong class="text-slate-400">Create
                                    Ad</strong> to publish your first sponsored placement.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Placement Guide ‚îÄ‚îÄ -->
    <div class="mt-6 rounded-2xl p-5 border border-white/8" style="background: rgba(255,255,255,0.02);">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Placement Zones</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-xs text-slate-500">
            <div class="p-3 rounded-xl border border-blue-500/15" style="background:rgba(59,130,246,0.05)">
                <span class="text-blue-400 font-bold block mb-1">home_banner</span>
                Full-width banner on the homepage hero section
            </div>
            <div class="p-3 rounded-xl border border-purple-500/15" style="background:rgba(124,58,237,0.05)">
                <span class="text-purple-400 font-bold block mb-1">search_sidebar</span>
                Injected after the 2nd result card in search results
            </div>
            <div class="p-3 rounded-xl border border-green-500/15" style="background:rgba(16,185,129,0.05)">
                <span class="text-green-400 font-bold block mb-1">listing_detail</span>
                Shown below the main listing info on detail pages
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  CREATE AD MODAL                         -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="create-ad-modal" tabindex="-1" aria-hidden="true"
    class="hidden overflow-y-auto overflow-x-hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    style="background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);">
    <div class="relative w-full max-w-lg">
        <div class="rounded-2xl overflow-hidden shadow-2xl border border-white/15" style="background: #0d1117;">

            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-white/10"
                style="background: linear-gradient(135deg, rgba(124,58,237,0.3), rgba(26,86,219,0.3));">
                <div class="flex items-center gap-2">
                    <i class="fas fa-plus-circle text-purple-400"></i>
                    <h3 class="text-lg font-bold text-white">Create New Ad</h3>
                </div>
                <button data-modal-hide="create-ad-modal"
                    class="text-slate-400 hover:text-white transition-colors p-1 rounded-lg hover:bg-white/10">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Form -->
            <form class="px-6 py-6 space-y-5" action="{{ url_for('main.admin_ads') }}" method="POST">

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Ad Title</label>
                    <input type="text" name="title" required placeholder="e.g. Sporty's Pilot Shop ‚Äî 20% Off"
                        class="block w-full rounded-xl px-4 py-3 text-sm text-white focus:ring-2 focus:ring-purple-500 focus:outline-none transition-all"
                        style="background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.15);">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Image
                        URL</label>
                    <input type="url" name="image_url" required placeholder="https://cdn.yoursite.com/banner.jpg"
                        class="block w-full rounded-xl px-4 py-3 text-sm text-white focus:ring-2 focus:ring-purple-500 focus:outline-none transition-all"
                        style="background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.15);">
                    <p class="text-xs text-slate-600 mt-1">Recommended: 1200√ó300px for banners, 400√ó300px for sidebar.
                    </p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Destination
                        URL</label>
                    <input type="url" name="link_url" required placeholder="https://sponsor.com/offer"
                        class="block w-full rounded-xl px-4 py-3 text-sm text-white focus:ring-2 focus:ring-purple-500 focus:outline-none transition-all"
                        style="background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.15);">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Placement
                        Zone</label>
                    <select name="placement"
                        class="block w-full rounded-xl px-4 py-3 text-sm text-white focus:ring-2 focus:ring-purple-500 focus:outline-none transition-all"
                        style="background: rgba(30,41,59,1); border: 1px solid rgba(255,255,255,0.15);">
                        <option value="home_banner" style="background:#0d1117;">üè† Home Banner</option>
                        <option value="search_sidebar" style="background:#0d1117;">üîç Search Sidebar</option>
                        <option value="listing_detail" style="background:#0d1117;">üìã Listing Detail</option>
                    </select>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="submit"
                        class="flex-1 font-bold py-3 rounded-xl text-white transition-all hover:-translate-y-0.5 active:translate-y-0"
                        style="background: linear-gradient(135deg,#7c3aed,#1a56db);">
                        <i class="fas fa-rocket mr-2"></i>Publish Ad
                    </button>
                    <button type="button" data-modal-hide="create-ad-modal"
                        class="px-5 py-3 rounded-xl font-bold text-slate-400 border border-white/15 hover:bg-white/10 transition-all">
                        Cancel
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

{% endblock %}