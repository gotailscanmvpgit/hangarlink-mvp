{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 lg:px-8 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <!-- Photos -->
            <div
                class="bg-white dark:bg-dark-900 rounded-2xl overflow-hidden shadow-xl border border-gray-200 dark:border-gray-700 mb-8 relative group">

                {% if listing.virtual_tour_url %}
                <a href="{{ listing.virtual_tour_url }}" target="_blank"
                    class="absolute bottom-4 right-4 bg-white/90 dark:bg-dark-800/90 backdrop-blur text-gray-900 dark:text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:scale-105 transition-all z-20 flex items-center border border-gray-200 dark:border-gray-600">
                    <i class="fas fa-vr-cardboard mr-2 text-blue-600"></i> 360Â° Virtual Tour
                </a>
                {% endif %}
                <!-- Hero Section with Carousel -->
                <div class="relative h-64 sm:h-96 w-full bg-gray-200 dark:bg-gray-800">
                    {% if listing.photos %}
                    {% set photos = listing.photos.split(',') %}

                    {% if photos|length > 1 %}
                    <!-- Flowbite Carousel -->
                    <div id="listing-carousel" class="relative w-full h-full" data-carousel="slide">
                        <!-- Carousel wrapper -->
                        <div class="relative h-full overflow-hidden">
                            {% for photo in photos %}
                            <div class="hidden duration-700 ease-in-out" data-carousel-item>
                                <img src="{{ url_for('static', filename='uploads/listings/' + photo) }}"
                                    class="absolute block w-full h-full object-cover"
                                    alt="Listing Photo {{ loop.index }}">
                            </div>
                            {% endfor %}
                        </div>
                        <!-- Slider indicators -->
                        <div
                            class="absolute z-30 flex -translate-x-1/2 bottom-5 left-1/2 space-x-3 rtl:space-x-reverse">
                            {% for photo in photos %}
                            <button type="button" class="w-3 h-3 rounded-full"
                                aria-current="{{ 'true' if loop.first else 'false' }}"
                                aria-label="Slide {{ loop.index }}" data-carousel-slide-to="{{ loop.index0 }}"></button>
                            {% endfor %}
                        </div>
                        <!-- Slider controls -->
                        <button type="button"
                            class="absolute top-0 start-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none"
                            data-carousel-prev>
                            <span
                                class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30 dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-4 group-focus:ring-white dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                                <svg class="w-4 h-4 text-white dark:text-gray-800 rtl:rotate-180" aria-hidden="true"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2" d="M5 1 1 5l4 4" />
                                </svg>
                                <span class="sr-only">Previous</span>
                            </span>
                        </button>
                        <button type="button"
                            class="absolute top-0 end-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none"
                            data-carousel-next>
                            <span
                                class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30 dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-4 group-focus:ring-white dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                                <svg class="w-4 h-4 text-white dark:text-gray-800 rtl:rotate-180" aria-hidden="true"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2" d="m1 9 4-4-4-4" />
                                </svg>
                                <span class="sr-only">Next</span>
                            </span>
                        </button>
                    </div>
                    {% else %}
                    <!-- Single Image -->
                    <img src="{{ url_for('static', filename='uploads/listings/' + photos[0]) }}"
                        class="w-full h-full object-cover" alt="Listing Photo">
                    {% endif %}

                    {% else %}
                    <!-- Fallback Gradient -->
                    <div
                        class="w-full h-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                        <i class="fas fa-plane text-white text-8xl opacity-50"></i>
                    </div>
                    {% endif %}

                    <!-- Status Badge -->
                    <div class="absolute top-4 left-4 z-40">
                        {% if listing.status == 'Active' %}
                        <span
                            class="bg-green-100/90 backdrop-blur text-green-800 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">
                            <i class="fas fa-check-circle mr-1.5"></i>Active
                        </span>
                        {% elif listing.status == 'Rented' %}
                        <span
                            class="bg-red-100/90 backdrop-blur text-red-800 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">
                            <i class="fas fa-lock mr-1.5"></i>Rented
                        </span>
                        {% else %}
                        <span
                            class="bg-gray-100/90 backdrop-blur text-gray-800 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">
                            {{ listing.status }}
                        </span>
                        {% endif %}
                    </div>

                    {% if listing.is_premium_listing %}
                    <div class="absolute top-4 right-4 z-40">
                        <span
                            class="bg-amber-100/90 backdrop-blur text-amber-800 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm border border-amber-200">
                            <i class="fas fa-crown text-amber-600 mr-1.5"></i>Premium
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Concierge Widget -->
            <div class="fixed bottom-6 right-6 z-50">
                <button onclick="toggleConcierge()"
                    class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded-full p-4 shadow-2xl flex items-center transition-transform hover:scale-110 hover:rotate-3 border-2 border-white/20">
                    <i class="fas fa-robot text-2xl mr-2"></i>
                    <span class="font-bold hidden md:inline">Ask AI Concierge</span>
                </button>
            </div>

            <div id="concierge-modal"
                class="fixed bottom-24 right-6 w-80 sm:w-96 bg-white dark:bg-dark-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 hidden z-50 flex flex-col overflow-hidden animate-fade-in-up">
                <div
                    class="bg-gradient-to-r from-blue-900 to-purple-900 p-4 text-white flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-robot mr-2"></i>HangarLink Concierge</h3>
                    <button onclick="toggleConcierge()" class="text-blue-200 hover:text-white"><i
                            class="fas fa-times"></i></button>
                </div>
                <div id="chat-history"
                    class="h-80 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-dark-900 custom-scrollbar">
                    <div class="flex items-start animate-fade-in">
                        <div class="flex-shrink-0 mr-2">
                            <div
                                class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                <i class="fas fa-robot text-xs"></i>
                            </div>
                        </div>
                        <div
                            class="bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-700 rounded-2xl rounded-tl-none p-3 max-w-[85%] text-sm text-gray-800 dark:text-gray-200 shadow-sm">
                            Hi! I'm your advanced hangar assistant. How can I help you with this listing at <strong>{{
                                listing.airport_icao }}</strong>?
                        </div>
                    </div>
                </div>
                <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-800">
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Ask about price, lease terms..."
                            class="flex-grow rounded-xl border-gray-300 dark:border-gray-600 dark:bg-dark-900 text-sm p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                            onkeypress="if(event.key==='Enter') sendChat()">
                        <button onclick="sendChat()"
                            class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 transition-colors shadow-lg"><i
                                class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <script>
                function toggleConcierge() {
                    const modal = document.getElementById('concierge-modal');
                    modal.classList.toggle('hidden');
                    if (!modal.classList.contains('hidden')) {
                        document.getElementById('chat-input').focus();
                    }
                }
                function sendChat() {
                    const input = document.getElementById('chat-input');
                    const msg = input.value;
                    if (!msg) return;

                    // Add user msg
                    const history = document.getElementById('chat-history');
                    history.innerHTML += `
        <div class="flex justify-end animate-fade-in">
            <div class="bg-blue-600 text-white rounded-2xl rounded-tr-none p-3 max-w-[85%] text-sm shadow-md">
                ${msg}
            </div>
        </div>
    `;
                    input.value = '';
                    history.scrollTop = history.scrollHeight;

                    // Simulate thinking
                    const loadingId = 'loading-' + Date.now();
                    history.innerHTML += `
        <div id="${loadingId}" class="flex items-start animate-fade-in mt-3">
             <div class="flex-shrink-0 mr-2">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                    <i class="fas fa-robot text-xs"></i>
                </div>
            </div>
            <div class="bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-700 rounded-2xl rounded-tl-none p-3 max-w-[85%] shadow-sm flex items-center space-x-1">
                 <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                 <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                 <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        </div>
    `;
                    history.scrollTop = history.scrollHeight;

                    // API Call
                    fetch('/concierge/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: msg })
                    })
                        .then(r => r.json())
                        .then(data => {
                            document.getElementById(loadingId).remove();
                            history.innerHTML += `
             <div class="flex items-start animate-fade-in mt-3">
                <div class="flex-shrink-0 mr-2">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                        <i class="fas fa-robot text-xs"></i>
                    </div>
                </div>
                <div class="bg-white dark:bg-dark-800 border border-gray-200 dark:border-gray-700 rounded-2xl rounded-tl-none p-3 max-w-[85%] text-sm text-gray-800 dark:text-gray-200 shadow-sm">
                    ${data.response}
                </div>
            </div>
        `;
                            history.scrollTop = history.scrollHeight;
                        });
                }
            </script>

            <!-- Details -->
            <div
                class="bg-white dark:bg-dark-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-8">
                <div class="flex items-start justify-between mb-6">
                    <div>
                        {% if listing.condition_verified %}
                        <div class="mb-2">
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200 shadow-sm animate-fade-in">
                                <i class="fas fa-check-circle mr-1"></i> Verified Condition
                            </span>
                        </div>
                        {% endif %}
                        {% if listing.owner.is_premium %}
                        <div class="mb-2">
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-800 border border-amber-200 shadow-sm">
                                <i class="fas fa-star mr-1"></i> Premium Owner
                            </span>
                        </div>
                        {% endif %}
                        <h1 class="text-4xl font-bold text-gray-900 dark:text-platinum-100 mb-2">
                            {{ listing.airport_icao }} - Aircraft Parking
                        </h1>
                        <div class="flex items-center gap-4 text-gray-600 dark:text-platinum-300">
                            <span class="inline-flex items-center">
                                <i class="fas fa-ruler-combined mr-2 text-blue-600"></i>{{ listing.size_sqft|int }} sq
                                ft
                            </span>
                            <span class="inline-flex items-center">
                                {% if listing.covered %}
                                <i class="fas fa-warehouse mr-2 text-blue-600"></i>Covered
                                {% else %}
                                <i class="fas fa-cloud-sun mr-2 text-blue-600"></i>Outdoor
                                {% endif %}
                            </span>
                            <span class="inline-flex items-center">
                                <i class="fas fa-calendar mr-2 text-blue-600"></i>{{ listing.created_at.strftime('%b %d,
                                %Y') }}
                            </span>
                        </div>
                    </div>

                    <div class="text-right">
                        <div class="text-4xl font-bold text-blue-600">${{ listing.price_month|int }}</div>
                        <div class="text-sm text-gray-500">per month</div>
                        <div class="text-xs text-gray-400 mt-1">+ 8% fee (${{ (listing.price_month * 0.08)|int }}) on
                            booking</div>
                    </div>
                </div>

                <hr class="border-gray-200 dark:border-gray-700 my-6">

                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-platinum-100 mb-4">Description</h2>
                    <p class="text-gray-600 dark:text-platinum-300 leading-relaxed whitespace-pre-line">
                        {{ listing.description or 'No description provided.' }}
                    </p>
                </div>

                <hr class="border-gray-200 dark:border-gray-700 my-6">

                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-platinum-100 mb-4">Features</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center text-gray-700 dark:text-platinum-200">
                            <i class="fas fa-check-circle text-green-600 mr-3"></i>
                            <span>{{ listing.size_sqft|int }} square feet</span>
                        </div>
                        <div class="flex items-center text-gray-700 dark:text-platinum-200">
                            <i class="fas fa-check-circle text-green-600 mr-3"></i>
                            <span>{% if listing.covered %}Covered hangar{% else %}Outdoor tie-down{% endif %}</span>
                        </div>
                        <div class="flex items-center text-gray-700 dark:text-platinum-200">
                            <i class="fas fa-check-circle text-green-600 mr-3"></i>
                            <span>{{ listing.airport_icao }} location</span>
                        </div>
                        <div class="flex items-center text-gray-700 dark:text-platinum-200">
                            <i class="fas fa-check-circle text-green-600 mr-3"></i>
                            <span>Active listing</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">

            <!-- Health Score & Availability (New Feature) -->
            <div
                class="bg-white dark:bg-dark-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6 overflow-hidden relative">
                <!-- Health Score Badge -->
                <div class="absolute top-0 right-0 p-4">
                    {% set score = listing.health_score %}
                    {% set color = 'green' if score >= 80 else 'yellow' if score >= 60 else 'red' %}
                    <div class="group relative">
                        <div
                            class="w-16 h-16 rounded-full border-4 border-{{ color }}-500 flex items-center justify-center bg-white dark:bg-dark-800 shadow-lg transform rotate-12 group-hover:rotate-0 transition-all">
                            <span class="text-xl font-bold text-{{ color }}-600">{{ score }}</span>
                        </div>
                        <div
                            class="absolute bottom-full right-0 mb-2 w-48 bg-gray-900 text-white text-xs rounded p-2 hidden group-hover:block z-50 shadow-xl">
                            <div class="font-bold border-b border-gray-700 pb-1 mb-1">Hangar Health Score</div>
                            <div>Score: {{ score }}/100</div>
                            <div class="text-gray-300">Trust Rating: {{ 'Excellent' if score >= 80 else 'Good' if score
                                >= 60 else 'Needs Info' }}</div>
                        </div>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-gray-900 dark:text-platinum-100 mb-4">Availability</h3>

                {% if listing.availability_start %}
                <div class="mb-4">
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-300 mb-1">
                        <i class="fas fa-calendar-check text-green-500 mr-2"></i>
                        <span class="font-semibold">Available:</span>
                    </div>
                    <div class="pl-6 text-gray-800 dark:text-platinum-100 font-medium">
                        {{ listing.availability_start.strftime('%b %d') }}
                        {% if listing.availability_end %} - {{ listing.availability_end.strftime('%b %d, %Y') }}{% else
                        %} onwards{% endif %}
                    </div>
                </div>
                {% else %}
                <div class="text-sm text-gray-500 italic mb-4">Contact owner for availability.</div>
                {% endif %}

                {% if current_user.is_authenticated and current_user.id != listing.owner_id %}
                <!-- Book Viewing Button -->
                <form action="{{ url_for('main.book_viewing', listing_id=listing.id) }}" method="POST" class="mt-4">
                    <div class="flex space-x-2 mb-2">
                        <input type="date" name="viewing_date" required
                            class="w-2/3 bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500">
                        <input type="time" name="viewing_time"
                            class="w-1/3 bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500">
                    </div>
                    <button type="submit"
                        class="w-full bg-white border-2 border-blue-600 text-blue-600 font-bold py-2 rounded-lg hover:bg-blue-50 transition-colors">
                        <i class="fas fa-eye mr-2"></i>Request Viewing
                    </button>
                </form>
                {% endif %}
            </div>

            <!-- Contact Owner Card -->
            <div
                class="bg-white dark:bg-dark-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6 sticky top-24">
                <h3 class="text-xl font-bold text-gray-900 dark:text-platinum-100 mb-4">Contact Owner</h3>

                <div class="mb-6 flex items-start space-x-4">
                    <div
                        class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                        {{ listing.owner.email[0].upper() }}
                    </div>
                    <div>
                        <div class="font-semibold text-gray-900 dark:text-platinum-100">{{
                            listing.owner.email.split('@')[0] }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 capitalize mb-1">{{ listing.owner.role }}
                        </div>

                        <!-- Reputation Score -->
                        <div
                            class="flex items-center text-xs text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20 px-2 py-1 rounded-full w-max border border-yellow-100 dark:border-yellow-900">
                            <i class="fas fa-star mr-1"></i>
                            <span class="font-bold mr-1">{{ listing.owner.reputation_score|round(1) }}</span>
                            <span class="text-gray-400 dark:text-gray-500">({{ listing.owner.rentals_count }}
                                deals)</span>
                        </div>
                    </div>
                </div>

                {% if current_user.is_authenticated %}
                {% if current_user.id == listing.owner_id %}
                <a href="{{ url_for('main.edit_listing', id=listing.id) }}"
                    class="block w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl text-center shadow-lg hover:shadow-xl transition-all hover-lift mb-3">
                    <i class="fas fa-edit mr-2"></i>Edit Listing
                </a>
                {% else %}
                <a href="{{ url_for('main.message_user', user_id=listing.owner_id, listing_id=listing.id) }}"
                    class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl text-center shadow-lg hover:shadow-xl transition-all hover-lift">
                    <i class="fas fa-envelope mr-2"></i>Message Owner
                </a>

                {% if listing.status == 'Active' %}
                <form action="{{ url_for('main.book_listing', listing_id=listing.id) }}" method="POST" class="mt-3">

                    <!-- Insurance Add-on -->
                    <div
                        class="mb-4 bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-800 rounded-xl p-3">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" name="add_insurance"
                                class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300 dark:border-gray-600">
                            <div class="ml-3">
                                <span class="block text-sm font-bold text-gray-900 dark:text-white">Add Liability
                                    Insurance</span>
                                <span class="block text-xs text-gray-500 dark:text-gray-400">Short-term coverage via
                                    <span class="font-bold text-blue-600">Avemco</span>.</span>
                                <span class="block text-xs font-mono text-gray-500 mt-1">+$45 base + $15/day</span>
                                <div class="flex gap-2 mt-2 opacity-60 grayscale hover:grayscale-0 transition-all">
                                    <!-- Placeholder Logos -->
                                    <div class="h-4 bg-gray-400 w-12 rounded"></div>
                                    <div class="h-4 bg-gray-400 w-12 rounded"></div>
                                </div>
                            </div>
                        </label>
                    </div>

                    <button type="submit"
                        class="block w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl text-center shadow-lg hover:shadow-xl transition-all hover-lift">
                        <i class="fas fa-bolt mr-2 text-yellow-300"></i>Reserve Now
                    </button>
                    <p class="text-xs text-center text-gray-500 mt-2 flex items-center justify-center">
                        <i class="fas fa-lock mr-1 text-green-500"></i>Secure payment via Stripe Escrow
                    </p>
                </form>
                {% elif listing.status == 'Rented' %}
                <div
                    class="mt-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl p-4 text-center">
                    <div class="font-bold text-green-800 dark:text-green-300 flex items-center justify-center mb-1">
                        <i class="fas fa-shield-alt mr-2 text-xl"></i> HangarLink Guaranteed
                    </div>
                    <p class="text-xs text-green-700 dark:text-green-400">Protected booking. Liability coverage active.
                    </p>
                </div>
                {% endif %}
                {% endif %}
                {% else %}
                <!-- Guest Message Form (New Feature) -->
                <form action="{{ url_for('main.contact_guest', listing_id=listing.id) }}" method="POST"
                    class="space-y-3 mt-4">
                    <div>
                        <label class="sr-only">Your Email</label>
                        <input type="email" name="guest_email" required placeholder="Your Email Address"
                            class="w-full bg-gray-50 dark:bg-dark-800 border border-gray-300 dark:border-gray-700 rounded-lg p-3 text-sm focus:ring-blue-500 dark:text-platinum-100">
                    </div>
                    <div>
                        <label class="sr-only">Message</label>
                        <textarea name="message" required rows="3" placeholder="Hi, is this space still available?"
                            class="w-full bg-gray-50 dark:bg-dark-800 border border-gray-300 dark:border-gray-700 rounded-lg p-3 text-sm focus:ring-blue-500 dark:text-platinum-100"></textarea>
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl text-center shadow-lg hover:shadow-xl transition-all animate-pulse-subtle">
                        <i class="fas fa-paper-plane mr-2"></i>Send Message as Guest
                    </button>
                </form>
                <div class="text-center mt-3">
                    <span class="text-gray-500 text-sm">or</span>
                    <a href="{{ url_for('main.login', next=url_for('main.listing_detail', id=listing.id)) }}"
                        class="text-blue-600 font-bold hover:underline text-sm ml-1">Login for full access</a>
                </div>
                {% endif %}

                <!-- Badges -->
                <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700 space-y-3">
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-shield-alt w-6 text-green-500 text-center"></i>
                        <span class="ml-2">Identity verified</span>
                    </div>
                    {% if listing.condition_verified %}
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-certificate w-6 text-yellow-500 text-center"></i>
                        <span class="ml-2 font-bold text-gray-800 dark:text-gray-200">Condition Guaranteed</span>
                    </div>
                    {% endif %}
                    {% if listing.health_score >= 80 %}
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-heart w-6 text-red-500 text-center"></i>
                        <span class="ml-2">High Health Score ({{ listing.health_score }})</span>
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>

    <!-- Nearby FBOs & Fuel Widget -->
    <div class="bg-white dark:bg-dark-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-platinum-100 mb-4 flex items-center">
            <i class="fas fa-gas-pump text-blue-600 mr-2"></i>Nearby Fuel & FBOs
        </h3>
        <div class="space-y-4">
            <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-gray-800 dark:text-gray-200">Signature Flight Support</span>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">Primary</span>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">122.95 MHz</div>
                <div class="flex justify-between text-sm">
                    <span class="text-green-600 font-semibold">Jet A: $6.50/gal</span>
                    <span class="text-blue-600 font-semibold">100LL: $7.20/gal</span>
                </div>
            </div>
        </div>
        <a href="#" class="block text-center text-sm text-blue-600 hover:text-blue-800 mt-4 font-medium">View All FBOs
            at {{ listing.airport_icao }}</a>
    </div>

    {% if ads and ads.listing_detail %}
    <!-- Featured Partner Ad -->
    <a href="{{ ads.listing_detail.link_url }}" target="_blank"
        class="block bg-white dark:bg-dark-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6 mb-6 overflow-hidden relative group hover:border-blue-400 transition-colors">
        <div
            class="absolute top-0 right-0 bg-gray-100 dark:bg-gray-800 text-gray-500 text-[10px] px-2 py-0.5 rounded-bl uppercase tracking-wider font-bold">
            Sponsored</div>
        <div class="flex items-start">
            <div class="flex-shrink-0 mr-4">
                <img src="{{ ads.listing_detail.image_url }}" alt="{{ ads.listing_detail.title }}"
                    class="w-16 h-16 object-cover rounded-lg border border-gray-200">
            </div>
            <div>
                <span class="text-blue-600 font-bold uppercase tracking-widest text-xs mb-1 block">Featured
                    Partner</span>
                <h4
                    class="text-base font-bold text-gray-900 dark:text-white mb-1 group-hover:text-blue-600 transition-colors">
                    {{ ads.listing_detail.title }}</h4>
                <div class="text-gray-500 text-sm flex items-center group-hover:underline">Visit Website <i
                        class="fas fa-arrow-right ml-1 text-xs"></i></div>
            </div>
        </div>
    </a>
    {% endif %}

    <!-- Share This Listing -->
    <div class="bg-white dark:bg-dark-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-platinum-100 mb-4">Share This Listing</h3>
        <div class="grid grid-cols-4 gap-3">
            <a href="https://wa.me/?text=Check out this hangar at {{ listing.airport_icao }}: {{ url_for('main.listing_detail', id=listing.id, _external=True) }}"
                target="_blank"
                class="flex flex-col items-center justify-center p-3 bg-green-50 hover:bg-green-100 dark:bg-green-900/20 dark:hover:bg-green-900/40 rounded-xl transition-colors text-green-600">
                <i class="fab fa-whatsapp text-2xl mb-1"></i>
                <span class="text-xs font-semibold">WhatsApp</span>
            </a>
            <a href="mailto:?subject=Hangar Listing at {{ listing.airport_icao }}&body=Check out this listing: {{ url_for('main.listing_detail', id=listing.id, _external=True) }}"
                class="flex flex-col items-center justify-center p-3 bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 rounded-xl transition-colors text-blue-600">
                <i class="fas fa-envelope text-2xl mb-1"></i>
                <span class="text-xs font-semibold">Email</span>
            </a>
            <a href="https://twitter.com/intent/tweet?text=Found great hangar space at {{ listing.airport_icao }}!&url={{ url_for('main.listing_detail', id=listing.id, _external=True) }}"
                target="_blank"
                class="flex flex-col items-center justify-center p-3 bg-sky-50 hover:bg-sky-100 dark:bg-sky-900/20 dark:hover:bg-sky-900/40 rounded-xl transition-colors text-sky-500">
                <i class="fab fa-twitter text-2xl mb-1"></i>
                <span class="text-xs font-semibold">X</span>
            </a>
            <a href="sms:?body=Found a great hangar spot at {{ listing.airport_icao }}! {{ url_for('main.listing_detail', id=listing.id, _external=True) }}"
                class="flex flex-col items-center justify-center p-3 bg-indigo-50 hover:bg-indigo-100 dark:bg-indigo-900/20 dark:hover:bg-indigo-900/40 rounded-xl transition-colors text-indigo-600">
                <i class="fas fa-comment-alt text-2xl mb-1"></i>
                <span class="text-xs font-semibold">Text</span>
            </a>
        </div>
    </div>
</div>
</div>
</div>
</div>
{% endblock %}